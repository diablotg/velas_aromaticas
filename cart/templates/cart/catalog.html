<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Velas AromÃ¡ticas | CatÃ¡logo</title>

  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body { background: #ecececcc; }
    .product-card { cursor: pointer; transition: transform .08s ease; }
    .product-card:active { transform: scale(.995); }
    .cart-icon { position: fixed; right: 1rem; bottom: 1rem; z-index: 1080; }
    .offcanvas-end { width: 420px; max-width: 95%; }
    @media (max-width: 576px) { .offcanvas-end { width: 100%; } }
    .qty-badge { min-width: 2.1rem; text-align: center; }
    #discountMessage { min-height: 1.5rem; }
  </style>
</head>
<body>

<nav class="navbar bg-white shadow-sm mb-4">
  <div class="container">
    <a class="navbar-brand fw-bold" href="#">Velas AromÃ¡ticas SAMADHI.</a>
    <div>
      <button class="btn btn-outline-secondary position-relative" data-bs-toggle="offcanvas" data-bs-target="#cartDrawer" aria-controls="cartDrawer">
        ðŸ›’
        <span id="cartCountBadge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="font-size:0.75rem; display:none;">0</span>
      </button>
    </div>
  </div>
</nav>

<div class="container">
  <h2 class="mb-4 fs-2">Nuestros productos</h2>

  <div class="row g-4">
    {% for product in products %}
      <div class="col-md-4">
        <div class="card product-card h-100"
             data-id="{{ product.id }}"
             data-name="{{ product.name }}"
             data-price="{{ product.price }}">
          {% if product.image %}
            <img src="{{ product.image.url }}" class="card-img-top img-fluid" alt="{{ product.name }}" style="height: 250px; object-fit: cover;">
          {% else %}
            <img src="https://via.placeholder.com/400x300" class="card-img-top" alt="{{ product.name }}">
          {% endif %}
          <div class="card-body">
            <h5 class="card-title">{{ product.name }}</h5>
            <p class="card-text text-muted">{{ product.description }}</p>
            <div class="d-flex justify-content-between align-items-center">
              <strong>${{ product.price|floatformat:2 }}</strong>
              <button class="btn btn-sm btn-primary add-to-cart">Agregar</button>
            </div>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
</div>

<!-- Floating cart button (mobile) -->
<button class="btn btn-primary rounded-circle cart-icon d-md-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#cartDrawer">
  ðŸ›’
</button>

<!-- Offcanvas cart -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="cartDrawer">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title">Tu carrito</h5>
    <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas"></button>
  </div>
  <div class="offcanvas-body d-flex flex-column">
    <div id="cartItems" class="list-group mb-3">
      <div class="text-center text-muted py-5" id="emptyCartPrompt">Tu carrito estÃ¡ vacÃ­o. Agrega velas aromÃ¡ticas âœ¨</div>
    </div>

    <div class="mb-3">
      <label for="discountCode" class="form-label">CÃ³digo de descuento</label>
      <div class="input-group">
        <input type="text" id="discountCode" class="form-control" placeholder="Ingresa tu cÃ³digo">
        <button class="btn btn-outline-primary" id="applyDiscount">Aplicar</button>
      </div>
      <div id="discountMessage" class="form-text text-success"></div>
    </div>

    <div class="mt-auto">
      <div class="d-flex justify-content-between mb-2">
        <div>Subtotal</div>
        <div><strong id="cartSubtotal">$0.00</strong></div>
      </div>
      <div class="d-grid gap-2">
        <a href="#" class="btn btn-outline-secondary" id="viewCartBtn">Ver carrito completo</a>

        <!-- ðŸ”¥ AQUI SE AGREGA EL BOTÃ“N QUE YA LLAMA A checkout() -->
        <button onclick="checkout()" class="btn btn-primary">
          Proceder al pago
        </button>

      </div>
    </div>
  </div>
</div>

<!-- Bootstrap 5 JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
(() => {
  /* ============================
     CSRF + Variables
  ============================ */
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  const csrftoken = getCookie('csrftoken');

  const cartCountBadge = document.getElementById('cartCountBadge');
  const cartItemsContainer = document.getElementById('cartItems');
  const cartSubtotalEl = document.getElementById('cartSubtotal');
  const emptyPrompt = document.getElementById('emptyCartPrompt');
  const discountInput = document.getElementById('discountCode');
  const discountBtn = document.getElementById('applyDiscount');
  const discountMessage = document.getElementById('discountMessage');

  const fmt = (n) => Number(n).toLocaleString('es-MX', { style:'currency', currency:'MXN', minimumFractionDigits:2 });

  let cart = { items: [], subtotal: "0.00", count: 0 };
  let discountApplied = false;

  /* ============================
     Render Cart
  ============================ */
  function renderFromServerCart(serverCart) {
    cart.items = serverCart.items;
    cart.subtotal = serverCart.subtotal;
    cart.count = serverCart.count || serverCart.items.reduce((s,i)=>s+i.qty,0);

    cartItemsContainer.innerHTML = '';
    emptyPrompt.style.display = cart.items.length === 0 ? 'block' : 'none';

    let total = parseFloat(serverCart.subtotal || "0.00");

    cart.items.forEach(item => {
      const li = document.createElement('div');
      li.className = 'list-group-item d-flex align-items-center';
      const img = item.image_url || 'https://via.placeholder.com/56x56';

      li.innerHTML = `
        <div class="flex-shrink-0 me-3" style="width:56px;">
          <img src="${img}" alt="${item.name}" class="img-fluid rounded">
        </div>
        <div class="flex-grow-1">
          <div class="d-flex justify-content-between align-items-start">
            <div><div class="fw-semibold">${item.name}</div></div>
            <div class="text-end">
              <div class="fw-bold">${fmt(item.line_total)}</div>
              <small class="text-muted">${fmt(item.price)} c/u</small>
            </div>
          </div>
          <div class="mt-2 d-flex gap-2 align-items-center">
            <button class="btn btn-sm btn-outline-secondary decrease-qty" data-id="${item.id}">âˆ’</button>
            <span class="badge bg-light text-dark qty-badge">${item.qty}</span>
            <button class="btn btn-sm btn-outline-secondary increase-qty" data-id="${item.id}">+</button>
            <button class="btn btn-sm btn-link text-danger ms-2 remove-item" data-id="${item.id}">Eliminar</button>
          </div>
        </div>
      `;
      cartItemsContainer.appendChild(li);
    });

    if (discountApplied) total *= 0.9;
    cartSubtotalEl.textContent = fmt(total);

    cartCountBadge.style.display = cart.count > 0 ? 'inline-block' : 'none';
    cartCountBadge.textContent = cart.count;

    document.querySelectorAll('.increase-qty').forEach(btn => {
      btn.onclick = () => ajaxUpdateQty(btn.dataset.id, +1);
    });
    document.querySelectorAll('.decrease-qty').forEach(btn => {
      btn.onclick = () => ajaxUpdateQty(btn.dataset.id, -1);
    });
    document.querySelectorAll('.remove-item').forEach(btn => {
      btn.onclick = () => ajaxRemove(btn.dataset.id);
    });
  }

  async function fetchCart() {
    const res = await fetch('/api/cart/');
    if (!res.ok) return;
    const data = await res.json();
    if (data.success) renderFromServerCart(data.cart);
  }

  async function ajaxAdd(productId, qty = 1) {
    const form = new FormData();
    form.append('product_id', productId);
    form.append('qty', qty);
    const res = await fetch('/api/cart/add/', {
      method: 'POST',
      headers: { 'X-CSRFToken': csrftoken },
      body: form
    });
    const data = await res.json();
    if (data.success) renderFromServerCart(data.cart);
  }

  async function ajaxRemove(productId) {
    const form = new FormData();
    form.append('product_id', productId);
    const res = await fetch('/api/cart/remove/', {
      method: 'POST',
      headers: { 'X-CSRFToken': csrftoken },
      body: form
    });
    const data = await res.json();
    if (data.success) renderFromServerCart(data.cart);
  }

  async function ajaxUpdateQty(productId, delta) {
    const item = cart.items.find(i => String(i.id) === String(productId));
    const currentQty = item ? item.qty : 0;
    const newQty = Math.max(0, currentQty + delta);

    const form = new FormData();
    form.append('product_id', productId);
    form.append('qty', newQty);

    const res = await fetch('/api/cart/update/', {
      method: 'POST',
      headers: { 'X-CSRFToken': csrftoken },
      body: form
    });
    const data = await res.json();
    if (data.success) renderFromServerCart(data.cart);
  }

  function attachAddButtons() {
    document.querySelectorAll('.add-to-cart').forEach(btn=>{
      btn.onclick = async () => {
        const card = btn.closest('.product-card');
        const id = card.dataset.id;

        await ajaxAdd(id, 1);

        const offcanvasEl = document.getElementById('cartDrawer');
        const bsOffcanvas = bootstrap.Offcanvas.getOrCreateInstance(offcanvasEl);
        bsOffcanvas.show();
      };
    });
  }

  /* ============================
     DESCUENTO
  ============================ */
  discountBtn.addEventListener('click', () => {
    const code = discountInput.value.trim().toUpperCase();
    if (code === 'VELA10') {
      discountApplied = true;
      discountMessage.textContent = 'Â¡CÃ³digo vÃ¡lido! 10% de descuento aplicado';
      discountMessage.classList.remove('text-danger');
      discountMessage.classList.add('text-success');
    } else {
      discountApplied = false;
      discountMessage.textContent = 'CÃ³digo invÃ¡lido';
      discountMessage.classList.remove('text-success');
      discountMessage.classList.add('text-danger');
    }
    renderFromServerCart({items: cart.items, subtotal: cart.subtotal});
  });

  /* ============================
     ðŸ”¥ AquÃ­ agregamos checkout()
  ============================ */
  window.checkout = function() {
    if (cart.items.length === 0) {
      alert("Tu carrito estÃ¡ vacÃ­o");
      return;
    }

    fetch("/checkout/create-order/", {
        method: "POST",
        headers: {
            "X-CSRFToken": getCookie("csrftoken"),
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.order_id) {
            alert("Orden creada correctamente. ID: " + data.order_id);
        } else {
            alert("Error al crear la orden");
        }
    });
  };

  /* ============================
     InicializaciÃ³n
  ============================ */
  fetchCart().then(() => attachAddButtons());

})();
</script>

</body>
</html>
