<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Velas AromÃ¡ticas | CatÃ¡logo</title>

  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body { background: #f8f9fa; }
    .product-card { cursor: pointer; transition: transform .08s ease; }
    .product-card:active { transform: scale(.995); }
    .cart-icon { position: fixed; right: 1rem; bottom: 1rem; z-index: 1080; }
    .offcanvas-end { width: 420px; max-width: 95%; }
    @media (max-width: 576px) { .offcanvas-end { width: 100%; } }
    .qty-badge { min-width: 2.1rem; text-align: center; }
    #discountMessage { min-height: 1.5rem; }
  </style>
</head>
<body>

<nav class="navbar bg-white shadow-sm mb-4">
  <div class="container">
    <a class="navbar-brand fw-bold" href="#">Velas AromÃ¡ticas JET</a>
    <div>
      <button class="btn btn-outline-secondary position-relative" data-bs-toggle="offcanvas" data-bs-target="#cartDrawer" aria-controls="cartDrawer">
        ðŸ›’ Carrito
        <span id="cartCountBadge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="font-size:0.75rem; display:none;">0</span>
      </button>
    </div>
  </div>
</nav>

<div class="container">
  <h2 class="mb-4">Nuestros productos</h2>

  <div class="row g-4">
    {% for product in products %}
      <div class="col-md-4">
        <div class="card product-card h-100" 
             data-id="{{ product.id }}" 
             data-name="{{ product.name }}" 
             data-price="{{ product.price }}">
          {% if product.image %}
            <img src="{{ product.image.url }}" class="card-img-top" alt="{{ product.name }}">
          {% else %}
            <img src="https://via.placeholder.com/400x300" class="card-img-top" alt="{{ product.name }}">
          {% endif %}
          <div class="card-body">
            <h5 class="card-title">{{ product.name }}</h5>
            <p class="card-text text-muted">{{ product.description }}</p>
            <div class="d-flex justify-content-between align-items-center">
              <strong>${{ product.price|floatformat:2 }}</strong>
              <button class="btn btn-sm btn-primary add-to-cart">Agregar</button>
            </div>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
</div>

<!-- Floating cart button (mobile) -->
<button class="btn btn-primary rounded-circle cart-icon d-md-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#cartDrawer" aria-controls="cartDrawer" title="Abrir carrito">
  ðŸ›’
</button>

<!-- Offcanvas cart (drawer) -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="cartDrawer" aria-labelledby="cartDrawerLabel">
  <div class="offcanvas-header">
    <h5 id="cartDrawerLabel" class="offcanvas-title">Tu carrito</h5>
    <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Cerrar"></button>
  </div>
  <div class="offcanvas-body d-flex flex-column">
    <div id="cartItems" class="list-group mb-3">
      <div class="text-center text-muted py-5" id="emptyCartPrompt">Tu carrito estÃ¡ vacÃ­o. Agrega velas aromÃ¡ticas âœ¨</div>
    </div>

    <div class="mb-3">
      <label for="discountCode" class="form-label">CÃ³digo de descuento</label>
      <div class="input-group">
        <input type="text" id="discountCode" class="form-control" placeholder="Ingresa tu cÃ³digo">
        <button class="btn btn-outline-primary" id="applyDiscount">Aplicar</button>
      </div>
      <div id="discountMessage" class="form-text text-success"></div>
    </div>

    <div class="mt-auto">
      <div class="d-flex justify-content-between mb-2">
        <div>Subtotal</div>
        <div><strong id="cartSubtotal">$0.00</strong></div>
      </div>
      <div class="d-grid gap-2">
        <a href="#" class="btn btn-outline-secondary" id="viewCartBtn">Ver carrito completo</a>
        <button class="btn btn-primary" id="checkoutBtn" data-bs-dismiss="offcanvas">Finalizar compra</button>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap 5 JS + Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- Carrito JS -->
<script>

(() => {
  // Helpers CSRF
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  const csrftoken = getCookie('csrftoken');

  // DOM refs
  const cartCountBadge = document.getElementById('cartCountBadge');
  const cartItemsContainer = document.getElementById('cartItems');
  const cartSubtotalEl = document.getElementById('cartSubtotal');
  const emptyPrompt = document.getElementById('emptyCartPrompt');
  const discountInput = document.getElementById('discountCode');
  const discountBtn = document.getElementById('applyDiscount');
  const discountMessage = document.getElementById('discountMessage');

  const fmt = (n) => Number(n).toLocaleString('es-MX', { style:'currency', currency:'MXN', minimumFractionDigits:2 });

  // cart object local is kept for UI convenience, but authoritative state comes from server
  let cart = { items: [], subtotal: "0.00", count: 0 };
  let discountApplied = false;

  // Render UI from server cart state
  function renderFromServerCart(serverCart) {
    cart.items = serverCart.items;
    cart.subtotal = serverCart.subtotal;
    cart.count = serverCart.count || serverCart.items.reduce((s,i)=>s+i.qty,0);
    // clear container
    cartItemsContainer.innerHTML = '';
    if (cart.items.length === 0) {
      emptyPrompt.style.display = 'block';
    } else {
      emptyPrompt.style.display = 'none';
    }
    let total = parseFloat(serverCart.subtotal || "0.00");

    cart.items.forEach(item => {
      const li = document.createElement('div');
      li.className = 'list-group-item d-flex align-items-center';
      const img = item.image_url || 'https://via.placeholder.com/56x56';
      li.innerHTML = `
        <div class="flex-shrink-0 me-3" style="width:56px;">
          <img src="${img}" alt="${item.name}" class="img-fluid rounded">
        </div>
        <div class="flex-grow-1">
          <div class="d-flex justify-content-between align-items-start">
            <div><div class="fw-semibold">${item.name}</div></div>
            <div class="text-end">
              <div class="fw-bold">${fmt(item.line_total)}</div>
              <small class="text-muted">${fmt(item.price)} c/u</small>
            </div>
          </div>
          <div class="mt-2 d-flex gap-2 align-items-center">
            <button class="btn btn-sm btn-outline-secondary decrease-qty" data-id="${item.id}">âˆ’</button>
            <span class="badge bg-light text-dark qty-badge">${item.qty}</span>
            <button class="btn btn-sm btn-outline-secondary increase-qty" data-id="${item.id}">+</button>
            <button class="btn btn-sm btn-link text-danger ms-2 remove-item" data-id="${item.id}">Eliminar</button>
          </div>
        </div>
      `;
      cartItemsContainer.appendChild(li);
    });

    if (discountApplied) total = total * 0.9;
    cartSubtotalEl.textContent = fmt(total);

    if (cart.count > 0) {
      cartCountBadge.style.display = 'inline-block';
      cartCountBadge.textContent = cart.count;
    } else {
      cartCountBadge.style.display = 'none';
    }

    // wire events
    document.querySelectorAll('.increase-qty').forEach(btn => {
      btn.onclick = () => ajaxUpdateQty(btn.dataset.id, +1);
    });
    document.querySelectorAll('.decrease-qty').forEach(btn => {
      btn.onclick = () => ajaxUpdateQty(btn.dataset.id, -1);
    });
    document.querySelectorAll('.remove-item').forEach(btn => {
      btn.onclick = () => ajaxRemove(btn.dataset.id);
    });
  }

  // Fetch server cart on load
  async function fetchCart() {
    const res = await fetch('/api/cart/');
    if (!res.ok) return;
    const data = await res.json();
    if (data.success) {
      renderFromServerCart(data.cart);
    }
  }

  // Add item via API (adds +1 or qty)
  async function ajaxAdd(productId, qty = 1) {
    const form = new FormData();
    form.append('product_id', productId);
    form.append('qty', qty);
    const res = await fetch('/api/cart/add/', {
      method: 'POST',
      headers: { 'X-CSRFToken': csrftoken },
      body: form
    });
    const data = await res.json();
    if (data.success) renderFromServerCart(data.cart);
  }

  // Remove item
  async function ajaxRemove(productId) {
    const form = new FormData();
    form.append('product_id', productId);
    const res = await fetch('/api/cart/remove/', {
      method: 'POST',
      headers: { 'X-CSRFToken': csrftoken },
      body: form
    });
    const data = await res.json();
    if (data.success) renderFromServerCart(data.cart);
  }

  // Update qty delta (+1 or -1)
  async function ajaxUpdateQty(productId, delta) {
    // find current qty in DOM (or ask server state)
    const item = cart.items.find(i => String(i.id) === String(productId));
    const currentQty = item ? item.qty : 0;
    const newQty = currentQty + delta;
    const form = new FormData();
    form.append('product_id', productId);
    form.append('qty', Math.max(0, newQty));
    const res = await fetch('/api/cart/update/', {
      method: 'POST',
      headers: { 'X-CSRFToken': csrftoken },
      body: form
    });
    const data = await res.json();
    if (data.success) renderFromServerCart(data.cart);
  }

  // wire catalog add-to-cart buttons: use delegation or reattach after fetch catalog
  function attachAddButtons() {
    document.querySelectorAll('.add-to-cart').forEach(btn=>{
      btn.onclick = async () => {
        const card = btn.closest('.product-card');
        const id = card.dataset.id;
        // Call server
        await ajaxAdd(id, 1);
        // open offcanvas
        const offcanvasEl = document.getElementById('cartDrawer');
        const bsOffcanvas = bootstrap.Offcanvas.getOrCreateInstance(offcanvasEl);
        bsOffcanvas.show();
      };
    });
  }

  // Discount button (local demo)
  discountBtn.addEventListener('click', () => {
    const code = discountInput.value.trim().toUpperCase();
    if (code === 'VELA10') {
      discountApplied = true;
      discountMessage.textContent = 'Â¡CÃ³digo vÃ¡lido! 10% de descuento aplicado';
      discountMessage.classList.remove('text-danger');
      discountMessage.classList.add('text-success');
    } else {
      discountApplied = false;
      discountMessage.textContent = 'CÃ³digo invÃ¡lido';
      discountMessage.classList.remove('text-success');
      discountMessage.classList.add('text-danger');
    }
    // rerender using current server subtotal
    renderFromServerCart({items: cart.items, subtotal: cart.subtotal});
  });

  // view cart / checkout buttons (you can hook to /checkout later)
  document.getElementById('viewCartBtn').addEventListener('click', (e)=>{
    e.preventDefault();
    // si quieres abrir pÃ¡gina completa: window.location.href = '/cart/';
    alert('Ver carrito completo (redirigir a /cart en la app real).');
  });
  document.getElementById('checkoutBtn').addEventListener('click', ()=>{
    if (cart.items.length === 0) return alert('Tu carrito estÃ¡ vacÃ­o.');
    // redirigir a checkout real mÃ¡s adelante
    alert('Ir al checkout (redirigir a /checkout en la app real).');
  });

  // InicializaciÃ³n
  fetchCart().then(() => {
    attachAddButtons();
  });
})();
</script>

</body>
</html>


